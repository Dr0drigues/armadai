# CI â€” Quality gate on every push and pull request
#
# Ensures the code:
# 1. Compiles on stable Rust (build)
# 2. Passes all tests (test)
# 3. Has no lint warnings (clippy with -D warnings)
# 4. Follows formatting conventions (rustfmt)
# 5. Commit messages follow Conventional Commits (on PRs)
#
# Runs on: every push to master/develop, every pull request
#
# Performance strategy:
# - Heavy optional deps (surrealdb+rocksdb, ratatui) are behind feature flags
# - clippy/test run with `--no-default-features --features tui` (skips RocksDB C++ build)
# - build --release compiles with all default features (full binary)
# - Swatinem/rust-cache caches ~/.cargo and target/ between runs
# - Cache is shared across clippy/test/build via shared-key
# - Cache is only saved on develop pushes (save-if), PRs read from it

name: CI

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master, develop]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"
  CARGO_INCREMENTAL: 0

jobs:
  fmt:
    name: Formatting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-cargo
          save-if: ${{ github.ref == 'refs/heads/develop' }}
      - run: cargo clippy --all-targets --no-default-features --features tui -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-cargo
          save-if: ${{ github.ref == 'refs/heads/develop' }}
      - run: cargo test --no-default-features --features tui

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-cargo-release
          save-if: ${{ github.ref == 'refs/heads/develop' }}
      - run: cargo build --release

  commits:
    name: Conventional Commits
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: pip
      - run: pip install commitizen
      - name: Check PR commits
        run: |
          cz check --rev-range origin/${{ github.base_ref }}..HEAD
