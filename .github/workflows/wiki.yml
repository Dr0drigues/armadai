# Wiki sync — publish docs/wiki/ pages to the GitHub Wiki
#
# Triggers on pushes to develop that modify files in docs/wiki/.
# Converts filenames from kebab-case to Title-Case (GitHub wiki convention),
# fixes internal markdown links, and pushes to the wiki repository.
#
# Requires: wiki must be initialized (at least one page created manually).

name: Wiki Sync

on:
  push:
    branches: [develop]
    paths:
      - "docs/wiki/**"

jobs:
  sync:
    name: Publish to Wiki
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Checkout wiki
        uses: actions/checkout@v6
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync wiki pages
        run: |
          # Map of source filenames to wiki page names
          declare -A PAGE_MAP=(
            ["getting-started.md"]="Getting-Started.md"
            ["agent-format.md"]="Agent-Format.md"
            ["providers.md"]="Providers.md"
            ["templates.md"]="Templates.md"
            ["starter-packs.md"]="Starter-Packs.md"
            ["registry.md"]="Registry.md"
            ["linker.md"]="Linker.md"
            ["coordinator.md"]="Coordinator.md"
            ["pirate-crew.md"]="Pirate-Crew.md"
          )

          # Link replacements: source .md references → wiki page names
          declare -A LINK_MAP=(
            ["getting-started.md"]="Getting-Started"
            ["agent-format.md"]="Agent-Format"
            ["providers.md"]="Providers"
            ["templates.md"]="Templates"
            ["starter-packs.md"]="Starter-Packs"
            ["registry.md"]="Registry"
            ["linker.md"]="Linker"
            ["coordinator.md"]="Coordinator"
            ["pirate-crew.md"]="Pirate-Crew"
          )

          for src in docs/wiki/*.md; do
            filename=$(basename "$src")
            # Use mapped name or convert kebab-case to Title-Case
            if [[ -n "${PAGE_MAP[$filename]}" ]]; then
              dest="wiki/${PAGE_MAP[$filename]}"
            else
              # Auto-convert: kebab-case.md → Kebab-Case.md
              dest="wiki/$(echo "$filename" | sed -E 's/(^|-)([a-z])/\1\u\2/g')"
            fi

            cp "$src" "$dest"

            # Fix internal links
            for key in "${!LINK_MAP[@]}"; do
              sed -i "s|($key)|( ${LINK_MAP[$key]})|g" "$dest"
              # Also handle links with relative paths
              sed -i "s|(\./$key)|( ${LINK_MAP[$key]})|g" "$dest"
            done
          done

          # Generate Home.md with table of contents
          cat > wiki/Home.md << 'HOMEEOF'
          # ArmadAI Wiki

          AI agent fleet orchestrator — define, manage and run specialized agents from Markdown files.

          ## Pages

          HOMEEOF

          # Strip leading whitespace from heredoc
          sed -i 's/^          //' wiki/Home.md

          # Add links for each wiki page (excluding Home itself)
          for f in wiki/*.md; do
            page=$(basename "$f" .md)
            [[ "$page" == "Home" ]] && continue
            # Convert Title-Case to display name with spaces
            display=$(echo "$page" | sed 's/-/ /g')
            echo "- [$display]($page)" >> wiki/Home.md
          done

          cat >> wiki/Home.md << 'FOOTEREOF'

          ## Quick Links

          - [GitHub Repository](https://github.com/Dr0drigues/armadai)
          - [Releases](https://github.com/Dr0drigues/armadai/releases)
          - [Issues](https://github.com/Dr0drigues/armadai/issues)
          FOOTEREOF

          sed -i 's/^          //' wiki/Home.md

      - name: Push to wiki
        run: |
          cd wiki
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No wiki changes to commit."
          else
            git commit -m "docs: sync wiki from docs/wiki/"
            git push
          fi
